# üöÄ BACKEND: Nueva Implementaci√≥n de Ubicaci√≥n y Sectores

**Fecha:** 7 de octubre, 2025  
**Versi√≥n Backend:** 2.0  
**Breaking Changes:** ‚ö†Ô∏è S√ç (campo `sector` migrado a relaci√≥n)

---

## üìã Resumen Ejecutivo

Se ha realizado una **reestructuraci√≥n completa** del sistema de ubicaci√≥n y sectores para mejorar la experiencia de usuario y la consistencia de datos:

### ‚úÖ Cambios Principales:

1. **Sectores normalizados** ‚Üí Tabla `Sector` con 30 sectores predefinidos
2. **Ubicaci√≥n mejorada** ‚Üí Campos separados: `country`, `city`, `address`
3. **Nuevos endpoints** ‚Üí `/meta/sectors`, `/meta/cities/:countryCode`
4. **610 skills** ‚Üí Base de datos completa con skills profesionales

---

## üóÑÔ∏è Cambios en el Modelo de Datos

### MemberProfile (Antes)
```typescript
interface MemberProfile {
  // ... otros campos
  location?: string;  // ‚ùå Texto libre
  sector?: string;    // ‚ùå Texto libre
}
```

### MemberProfile (Ahora)
```typescript
interface MemberProfile {
  // ... otros campos
  
  // UBICACI√ìN MEJORADA
  country?: string;   // ‚úÖ C√≥digo ISO: "CO", "US", "MX", etc.
  city?: string;      // ‚úÖ Ciudad desde lista predefinida
  address?: string;   // ‚úÖ Direcci√≥n completa (opcional)
  location?: string;  // ‚ö†Ô∏è  DEPRECATED (mantener temporalmente)
  
  // SECTOR NORMALIZADO
  sectorId?: string;  // ‚úÖ FK a tabla Sector
  sector?: Sector;    // ‚úÖ Relaci√≥n con datos completos
}

interface Sector {
  id: string;
  name: string;         // slug: "technology", "finance", etc.
  nameEs: string;       // "Tecnolog√≠a", "Finanzas", etc.
  nameEn: string;       // "Technology", "Finance", etc.
  description?: string;
  icon?: string;        // emoji: "üíª", "üí∞", etc.
  order: number;
  active: boolean;
}
```

---

## üîå Nuevos Endpoints

### 1. GET /meta/sectors

**Descripci√≥n:** Lista de sectores profesionales desde base de datos

**Respuesta:**
```json
{
  "ok": true,
  "sectors": [
    {
      "id": "cm2abc123...",
      "name": "technology",
      "nameEs": "Tecnolog√≠a",
      "nameEn": "Technology",
      "description": "Desarrollo de software, hardware, servicios tecnol√≥gicos e innovaci√≥n digital",
      "icon": "üíª"
    },
    {
      "id": "cm2abc456...",
      "name": "finance",
      "nameEs": "Finanzas",
      "nameEn": "Finance",
      "description": "Banca, seguros, inversiones, fintech y servicios financieros",
      "icon": "üí∞"
    }
    // ... 28 sectores m√°s
  ],
  "total": 30
}
```

**Uso en React:**
```typescript
const { data } = useQuery({
  queryKey: ['sectors'],
  queryFn: async () => {
    const res = await fetch('https://proyectoia-backend.onrender.com/meta/sectors');
    return res.json();
  },
});

// En el select
<Select>
  {data?.sectors.map(sector => (
    <option key={sector.id} value={sector.id}>
      {sector.icon} {sector.nameEs}
    </option>
  ))}
</Select>
```

---

### 2. GET /meta/countries

**Descripci√≥n:** Lista completa de pa√≠ses (desde RestCountries API)

**Respuesta:**
```json
[
  {
    "code": "CO",
    "name": "Colombia",
    "dialCode": "+57",
    "flag": "üá®üá¥"
  },
  {
    "code": "US",
    "name": "United States",
    "dialCode": "+1",
    "flag": "üá∫üá∏"
  }
  // ... ~200+ pa√≠ses
]
```

**Uso en React:**
```typescript
const { data: countries } = useQuery({
  queryKey: ['countries'],
  queryFn: async () => {
    const res = await fetch('https://proyectoia-backend.onrender.com/meta/countries');
    return res.json();
  },
});

// En el select
<Select name="country" onChange={(e) => setCitiesFor(e.target.value)}>
  {countries?.map(country => (
    <option key={country.code} value={country.code}>
      {country.flag} {country.name}
    </option>
  ))}
</Select>
```

---

### 3. GET /meta/cities/:countryCode

**Descripci√≥n:** Lista de ciudades principales por pa√≠s

**Par√°metros:**
- `countryCode` (path): C√≥digo ISO del pa√≠s (ej: "CO", "US", "MX")

**Ejemplo:**
```bash
GET /meta/cities/CO
```

**Respuesta:**
```json
{
  "ok": true,
  "countryCode": "CO",
  "cities": [
    "Bogot√°",
    "Medell√≠n",
    "Cali",
    "Barranquilla",
    "Cartagena"
    // ... 15 ciudades m√°s
  ],
  "total": 20
}
```

**Uso en React:**
```typescript
const [selectedCountry, setSelectedCountry] = useState<string>('');

const { data: cities } = useQuery({
  queryKey: ['cities', selectedCountry],
  queryFn: async () => {
    const res = await fetch(`https://proyectoia-backend.onrender.com/meta/cities/${selectedCountry}`);
    return res.json();
  },
  enabled: !!selectedCountry, // Solo consultar si hay pa√≠s seleccionado
});

// En el select de ciudades
<Select name="city" disabled={!selectedCountry}>
  {cities?.cities.map(city => (
    <option key={city} value={city}>
      {city}
    </option>
  ))}
</Select>
```

---

### 4. GET /meta/stacks (Sin cambios)

**Descripci√≥n:** Lista de stacks tecnol√≥gicos comunes

**Respuesta:**
```json
{
  "ok": true,
  "stacks": [
    "MERN (MongoDB, Express, React, Node.js)",
    "MEAN (MongoDB, Express, Angular, Node.js)",
    "LAMP (Linux, Apache, MySQL, PHP)"
    // ... 12 m√°s
  ],
  "total": 15
}
```

---

## üîÑ Migraci√≥n del Frontend

### Paso 1: Actualizar Interfaces TypeScript

```typescript
// src/types/profile.ts

export interface Sector {
  id: string;
  name: string;       // slug
  nameEs: string;
  nameEn: string;
  description?: string;
  icon?: string;
}

export interface MemberProfile {
  id: string;
  userId: string;
  headline?: string;
  bio?: string;
  seniority?: string;
  
  // UBICACI√ìN (NUEVO)
  country?: string;   // C√≥digo ISO
  city?: string;      // Nombre de ciudad
  address?: string;   // Direcci√≥n completa
  
  availability?: number;
  stack?: string;
  
  // SECTOR (ACTUALIZADO)
  sectorId?: string;  // FK
  sector?: Sector;    // Relaci√≥n poblada
  
  // ... resto de campos
}

export interface Country {
  code: string;       // ISO alpha-2
  name: string;
  dialCode: string;
  flag: string;       // emoji
}

export interface CitiesResponse {
  ok: boolean;
  countryCode: string;
  cities: string[];
  total: number;
}
```

---

### Paso 2: Eliminar Constantes Locales de Sectores

**ANTES** (eliminar):
```typescript
// ‚ùå src/constants/sectors.ts - ELIMINAR ESTE ARCHIVO
export const SECTORS = [
  "Tecnolog√≠a",
  "Finanzas",
  // ...
];
```

**AHORA** (usar desde API):
```typescript
// ‚úÖ src/hooks/useSectors.ts
import { useQuery } from '@tanstack/react-query';

export function useSectors() {
  return useQuery({
    queryKey: ['sectors'],
    queryFn: async () => {
      const res = await fetch(`${import.meta.env.VITE_API_URL}/meta/sectors`);
      if (!res.ok) throw new Error('Failed to fetch sectors');
      return res.json();
    },
    staleTime: 1000 * 60 * 60, // 1 hora (los sectores no cambian frecuentemente)
  });
}
```

---

### Paso 3: Crear Hooks para Ubicaci√≥n

```typescript
// src/hooks/useCountries.ts
import { useQuery } from '@tanstack/react-query';

export function useCountries() {
  return useQuery({
    queryKey: ['countries'],
    queryFn: async () => {
      const res = await fetch(`${import.meta.env.VITE_API_URL}/meta/countries`);
      if (!res.ok) throw new Error('Failed to fetch countries');
      return res.json();
    },
    staleTime: 1000 * 60 * 60 * 24, // 24 horas
  });
}

// src/hooks/useCities.ts
import { useQuery } from '@tanstack/react-query';

export function useCities(countryCode?: string) {
  return useQuery({
    queryKey: ['cities', countryCode],
    queryFn: async () => {
      const res = await fetch(`${import.meta.env.VITE_API_URL}/meta/cities/${countryCode}`);
      if (!res.ok) throw new Error('Failed to fetch cities');
      return res.json();
    },
    enabled: !!countryCode,
    staleTime: 1000 * 60 * 60, // 1 hora
  });
}
```

---

### Paso 4: Actualizar Formularios

```typescript
// src/components/ProfileForm.tsx
import { useSectors } from '@/hooks/useSectors';
import { useCountries } from '@/hooks/useCountries';
import { useCities } from '@/hooks/useCities';

export function ProfileForm() {
  const [selectedCountry, setSelectedCountry] = useState<string>('');
  
  const { data: sectorsData } = useSectors();
  const { data: countries } = useCountries();
  const { data: citiesData } = useCities(selectedCountry);

  return (
    <form>
      {/* Sector */}
      <div>
        <label>Sector</label>
        <select name="sectorId" required>
          <option value="">Selecciona un sector</option>
          {sectorsData?.sectors.map(sector => (
            <option key={sector.id} value={sector.id}>
              {sector.icon} {sector.nameEs}
            </option>
          ))}
        </select>
      </div>

      {/* Pa√≠s */}
      <div>
        <label>Pa√≠s</label>
        <select 
          name="country" 
          onChange={(e) => setSelectedCountry(e.target.value)}
          required
        >
          <option value="">Selecciona un pa√≠s</option>
          {countries?.map(country => (
            <option key={country.code} value={country.code}>
              {country.flag} {country.name}
            </option>
          ))}
        </select>
      </div>

      {/* Ciudad */}
      <div>
        <label>Ciudad</label>
        <select 
          name="city" 
          disabled={!selectedCountry}
          required
        >
          <option value="">Selecciona una ciudad</option>
          {citiesData?.cities.map(city => (
            <option key={city} value={city}>
              {city}
            </option>
          ))}
        </select>
        {!selectedCountry && (
          <p className="text-sm text-gray-500">
            Primero selecciona un pa√≠s
          </p>
        )}
      </div>

      {/* Direcci√≥n (opcional) */}
      <div>
        <label>Direcci√≥n (opcional)</label>
        <input 
          type="text" 
          name="address" 
          placeholder="Ej: Calle 123 #45-67, Apartamento 102"
        />
      </div>
    </form>
  );
}
```

---

### Paso 5: Actualizar Llamadas a la API

**ANTES:**
```typescript
// ‚ùå Enviando sector como string
const profile = {
  ...otherFields,
  sector: "Tecnolog√≠a", // texto libre
  location: "Bogot√°, Colombia", // texto libre
};
```

**AHORA:**
```typescript
// ‚úÖ Enviando sectorId y ubicaci√≥n estructurada
const profile = {
  ...otherFields,
  sectorId: "cm2abc123...", // ID del sector
  country: "CO",            // C√≥digo ISO
  city: "Bogot√°",           // Ciudad desde lista
  address: "Calle 123",     // Direcci√≥n opcional
};
```

---

## üìä Endpoints Actualizados

### GET /users/:userId/profile

**Respuesta incluye sector poblado:**
```json
{
  "id": "cm2...",
  "userId": "user123",
  "headline": "Full Stack Developer",
  "seniority": "Senior",
  
  "country": "CO",
  "city": "Bogot√°",
  "address": "Calle 123 #45-67",
  
  "sectorId": "cm2sector123",
  "sector": {
    "id": "cm2sector123",
    "name": "technology",
    "nameEs": "Tecnolog√≠a",
    "nameEn": "Technology",
    "icon": "üíª",
    "description": "Desarrollo de software..."
  },
  
  "stack": "MERN (MongoDB, Express, React, Node.js)",
  "availability": 40
}
```

---

## ‚ö†Ô∏è Breaking Changes y Retrocompatibilidad

### Campo `sector` (String ‚Üí Relaci√≥n)

**Migraci√≥n autom√°tica:**
- El campo viejo `sector` (string) ya NO existe en el schema
- Ahora es `sectorId` (FK) ‚Üí `sector` (relaci√≥n)

**Acci√≥n requerida:**
1. ‚úÖ Actualizar todos los formularios para usar `sectorId`
2. ‚úÖ Actualizar interfaces TypeScript
3. ‚úÖ Mostrar `profile.sector.nameEs` en lugar de `profile.sector`

### Campo `location` (Deprecated)

**Estado actual:**
- `location` sigue existiendo pero est√° deprecated
- Se recomienda usar `country`, `city`, `address`

**Acci√≥n requerida:**
1. ‚úÖ Usar campos separados en nuevos formularios
2. ‚è≥ Mantener `location` solo para perfiles antiguos (display)
3. ‚è≥ Mostrar migraci√≥n sugerida a usuarios: "Actualiza tu ubicaci√≥n"

---

## üß™ Testing de Endpoints

### Usando cURL:

```bash
# Sectores
curl https://proyectoia-backend.onrender.com/meta/sectors

# Pa√≠ses
curl https://proyectoia-backend.onrender.com/meta/countries

# Ciudades de Colombia
curl https://proyectoia-backend.onrender.com/meta/cities/CO

# Ciudades de M√©xico
curl https://proyectoia-backend.onrender.com/meta/cities/MX

# Stacks
curl https://proyectoia-backend.onrender.com/meta/stacks
```

### Usando fetch en consola del navegador:

```javascript
// Sectores
fetch('https://proyectoia-backend.onrender.com/meta/sectors')
  .then(r => r.json())
  .then(console.log);

// Ciudades de Colombia
fetch('https://proyectoia-backend.onrender.com/meta/cities/CO')
  .then(r => r.json())
  .then(console.log);
```

---

## üì¶ Datos Completos

### Sectores (30 total):
üíª Tecnolog√≠a, üí∞ Finanzas, üè• Salud, üìö Educaci√≥n, üõí E-commerce, üè™ Retail, üè≠ Manufactura, üèóÔ∏è Construcci√≥n, üè† Bienes Ra√≠ces, üöö Transporte y Log√≠stica, ‚ö° Energ√≠a, üåæ Agricultura, üçî Alimentos y Bebidas, üè® Hoteler√≠a y Turismo, üé¨ Entretenimiento, üéÆ Gaming y eSports, üì° Telecomunicaciones, üì¢ Marketing y Publicidad, üíº Consultor√≠a, ‚öñÔ∏è Legal, ü§ù ONGs, üèõÔ∏è Gobierno y Sector P√∫blico, ‚öΩ Deportes y Fitness, üëó Moda y Textil, üöó Automotriz, ‚úàÔ∏è Aeroespacial, üß¨ Biotecnolog√≠a, üõ°Ô∏è Seguros, üîí Ciberseguridad, üì¶ Otro

### Skills (610 total):
Incluye: React, Vue.js, Angular, Next.js, TypeScript, Python, Django, Node.js, Express.js, PostgreSQL, MongoDB, Docker, Kubernetes, AWS, Azure, Machine Learning, TensorFlow, y 593 m√°s...

### Pa√≠ses con Ciudades:
- üá®üá¥ Colombia: 20 ciudades
- üá∫üá∏ Estados Unidos: 20 ciudades
- üá≤üáΩ M√©xico: 20 ciudades
- üá¶üá∑ Argentina: 15 ciudades
- üáßüá∑ Brasil: 15 ciudades
- üá®üá± Chile: 15 ciudades
- üáµüá™ Per√∫: 15 ciudades
- üá™üá® Ecuador: 15 ciudades
- üáªüá™ Venezuela: 15 ciudades
- üá™üá∏ Espa√±a: 20 ciudades
- Y m√°s pa√≠ses...

---

## ‚úÖ Checklist de Integraci√≥n Frontend

### Configuraci√≥n Inicial
- [ ] Actualizar interfaces TypeScript (`Sector`, `MemberProfile`, `Country`, `CitiesResponse`)
- [ ] Crear hooks (`useSectors`, `useCountries`, `useCities`)
- [ ] Eliminar constantes locales de sectores (`src/constants/sectors.ts`)

### Formularios
- [ ] Actualizar formulario de perfil con nuevos campos
- [ ] Implementar cascada Pa√≠s ‚Üí Ciudades
- [ ] Cambiar `sector` (string) ‚Üí `sectorId` (select)
- [ ] Agregar validaci√≥n de campos requeridos

### Visualizaci√≥n
- [ ] Mostrar `sector.nameEs` con icono `sector.icon`
- [ ] Mostrar ubicaci√≥n formateada: "üá®üá¥ Bogot√°, Colombia"
- [ ] Agregar tooltip con `sector.description`

### Migraci√≥n de Datos
- [ ] Detectar perfiles con `location` antiguo
- [ ] Mostrar banner: "Actualiza tu ubicaci√≥n para mejor visibilidad"
- [ ] Permitir edici√≥n f√°cil para migrar

### Testing
- [ ] Probar formulario de creaci√≥n de perfil
- [ ] Probar edici√≥n de perfil existente
- [ ] Verificar cascada pa√≠s ‚Üí ciudades
- [ ] Verificar que sectores se cargan correctamente
- [ ] Testing con diferentes pa√≠ses

---

## üÜò Soporte y Preguntas

Si tienes dudas o encuentras alg√∫n problema:

1. **Endpoints no funcionan:** Verifica que est√©s usando la URL correcta:
   ```
   https://proyectoia-backend.onrender.com/meta/...
   ```

2. **Sectores no aparecen:** Verifica que el backend est√© desplegado y la BD tenga los 30 sectores.

3. **Ciudades no cargan:** Aseg√∫rate de pasar el c√≥digo ISO correcto (may√∫sculas): `"CO"` no `"co"`

4. **Errores de tipo TypeScript:** Actualiza las interfaces seg√∫n este documento.

---

**Contacto Backend:** Disponible para resolver dudas sobre implementaci√≥n  
**Fecha de Deploy:** 7 de octubre, 2025  
**Pr√≥ximo deploy a producci√≥n:** Pendiente de commit y push
